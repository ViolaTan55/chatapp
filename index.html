<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gossip App</title>
        <script type="importmap">
            {
                "imports": {
                    "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
                    "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
                    "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
                    "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs"
                }
            }
        </script>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div id="app">
            
            <div v-if="!$graffitiSession.value">
                <h1>Gossip App</h1>
                <button @click="$graffiti.login()">
                    Log In
                </button>
            </div>
            <template v-else>
                <div v-if="newAccountSetup">
                    <h1>Welcome to the Gossip App</h1>
                    
                    <!-- Profile Selection -->
                    <graffiti-discover
                        v-slot="{ objects: profileObjects }"
                        :channels="['designftw']"
                        :schema="{
                            properties: {
                                value: {
                                    required: ['name', 'describes', 'published'],
                                    properties: {
                                        name: { type: 'string' },
                                        describes: { type: 'string' },
                                        published: { type: 'number' },
                                        email: { type: 'string' },
                                        anonymized: { type: 'string' },
                                        boundaries: { type: 'array' },
                                        generator: { type: 'string' }
                                    }
                                }
                            }
                        }"
                    >
                        <div v-if="!creatingNewProfile">
                            <div v-if="!profileObjects.filter(obj => obj.value.describes === $graffitiSession.value.actor).length" class="no-profiles">
                                <h2>No Profiles Found</h2>
                                <button @click="showProfileCreation" class="create-new-profile">Create New Profile</button>
                            </div>
                            <div v-else class="profile-selection">
                                <h2>Select a Profile</h2>
                                <div class="profile-list">
                                    <div v-for="obj in profileObjects.filter(obj => obj.value.describes === $graffitiSession.value.actor)" 
                                         :key="obj.url" 
                                         class="profile-item">
                                        <div class="profile-content" @click="selectProfile(obj.value)">
                                            <p><strong>Name:</strong> {{ obj.value.name }}</p>
                                            <p><strong>Email:</strong> {{ obj.value.email }}</p>
                                            <p><strong>Anonymized:</strong> {{ obj.value.anonymized }}</p>
                                            <p><strong>Boundaries:</strong> {{ obj.value.boundaries ? obj.value.boundaries.join(', ') : 'None' }}</p>
                                            <p><strong>Created:</strong> {{ new Date(obj.value.published).toLocaleString() }}</p>
                                        </div>
                                        <div class="profile-actions">
                                            <button @click.stop="deleteProfile(obj)" class="delete-profile">Delete</button>
                                        </div>
                                    </div>
                                </div>
                                <button @click="showProfileCreation" class="create-new-profile">Create New Profile</button>
                            </div>
                        </div>
                    </graffiti-discover>

                    <!-- Profile Creation Form -->
                    <div v-if="creatingNewProfile" class="profile-creation">
                        <h2>Create New Profile</h2>
                        <button @click="creatingNewProfile = false" class="back-button">← Back to Profiles</button>
                    <profile-view
                            :profile="profile"
                            :is-editing="true"
                            :is-setup="true"
                            @save="setupNewAccount"
                    @add-boundary="addBoundary"
                    @remove-boundary="removeBoundary"
                    />
                    </div>
                </div>
                <div v-else>
                    <!-- Debug section to show saved profiles -->
                    <!-- <div class="debug-section">
                        <h3>Saved Profiles</h3>
                        <graffiti-discover
                            v-slot="{ objects: profileObjects }"
                            :channels="['designftw', 'designftw-2025-studio2']"
                            :schema="{
                                properties: {
                                    value: {
                                        required: ['name', 'describes', 'published'],
                                        properties: {
                                            name: { type: 'string' },
                                            describes: { type: 'string' },
                                            published: { type: 'number' },
                                            email: { type: 'string' },
                                            anonymized: { type: 'string' },
                                            boundaries: { type: 'array' },
                                            generator: { type: 'string' }
                                        }
                                    }
                                }
                            }"
                        >
                            <div v-if="profileObjects.length === 0" class="no-profiles">
                                No profiles found
                            </div>
                            <div v-else class="profile-list">
                                <div v-for="obj in profileObjects" :key="obj.url" class="profile-item">
                                    <p><strong>Name:</strong> {{ obj.value.name }}</p>
                                    <p><strong>Email:</strong> {{ obj.value.email }}</p>
                                    <p><strong>Anonymized:</strong> {{ obj.value.anonymized }}</p>
                                    <p><strong>Boundaries:</strong> {{ obj.value.boundaries ? obj.value.boundaries.join(', ') : 'None' }}</p>
                                    <p><strong>Published:</strong> {{ new Date(obj.value.published).toLocaleString() }}</p>
                                </div>
                            </div>
                        </graffiti-discover>
                    </div> -->

                    <div v-if="viewingInvitations">
                        <div class="header">
                            <div class="clickable" @click="toggleInvitationsView">
                                <img class="clickable-image" src="img/home.png" style="max-height:80px;"/>
                            </div>
                            <h2>My Invitations</h2>
                            <div class="clickable" @click="toggleCreatingGroup">
                                <img class="clickable-image" src="img/plus.png" style="max-height:80px;"/>
                            </div>
                        </div>

                        <div class="invitations-container">
                            <graffiti-discover
                                v-slot="{ objects: invitationObjects }"
                                :channels="['invitations']"
                                :schema="{
                                    properties: {
                                        value: {
                                            required: ['groupName', 'inviter', 'status'],
                                            properties: {
                                                groupName: { type: 'string' },
                                                inviter: { type: 'string' },
                                                status: { type: 'string' },
                                                groupId: { type: 'string' }
                                            }
                                        }
                                    }
                                }"
                            >
                                <div v-if="invitationObjects.length === 0" class="no-invitations">
                                    No pending invitations
                                </div>
                                <div v-else class="invitation-list">
                                    <div v-for="invite in invitationObjects" :key="invite.url" class="invitation-item">
                                        <div class="invitation-details">
                                            <span class="group-name">{{ invite.value.groupName }}</span>
                                            <span class="inviter">Invited by: {{ invite.value.inviter }}</span>
                                        </div>
                                        <div class="invitation-actions">
                                            <button @click="acceptInvitation(invite)">Accept</button>
                                            <button @click="declineInvitation(invite)">Decline</button>
                                        </div>
                                    </div>
                                </div>
                            </graffiti-discover>
                        </div>

                        <div v-if="creatingGroup">
                            <h2>Create New Group</h2>
                            <form @submit.prevent="createGroupChat($graffitiSession.value)">
                                <fieldset :disabled="creating">
                                    <input
                                        type="text"
                                        v-model="groupChatName"
                                        placeholder="Group Name"
                                        ref="nameInput"
                                        v-focus
                                    />
                                    <input
                                        type="submit"
                                        :value="creating ? 'Creating...' : 'Create Group'"
                                    />
                                </fieldset>
                            </form>
                        </div>

                        <div v-if="selectedGroup" class="group-invite-section">
                            <h3>Invite to {{ selectedGroup.name }}</h3>
                            <div class="invite-link-container">
                                <input 
                                    type="text" 
                                    :value="inviteLink" 
                                    readonly 
                                    ref="inviteLinkInput"
                                />
                                <button @click="copyInviteLink">Copy Link</button>
                            </div>
                            <div v-if="showCopiedMessage" class="copied-message">
                                Link copied to clipboard!
                            </div>
                        </div>
                </div>
                <div v-else>

                <div v-if="viewingProfile">
                    <div class="profile-header">
                        <button class="back-button" @click="toggleProfileView">◀️ Back to Chat</button>
                    </div>
                    <profile-view
                        :profile="editingProfile ? profile : selectedProfile || existingProfile"
                        :is-editing="editingProfile"
                        @save="saveProfile($graffitiSession.value)"
                        @start-edit="startEditingProfile"
                        @add-boundary="addBoundary"
                        @remove-boundary="removeBoundary"
                        :class="{ 'closing': !viewingProfile }"
                    />
                </div>

                <template v-else>
                    <!-- home page -->
                    <div v-if="!selectedChannel">

                        <!-- home page header -->
                        <div class="header">
                            <div class="clickable" @click="toggleProfileView">
                                <img class="clickable-image" src="img/lemur.png" style="max-height:80px;"/>
                                <!-- My Profile -->
                            </div>
                            <h2>My Gossip Groups</h2>
                            <div class="clickable" @click="toggleCreatingGroup">
                                <img class="clickable-image" src="img/plus.png" style="max-height:80px;"/>
                                <!-- Create Group -->
                            </div>
                        </div>

                            <div v-if="showJoinGroup" class="join-group-section">
                                <h3>Join a Group</h3>
                                <div class="join-group-form">
                                    <input 
                                        type="text" 
                                        v-model="groupInviteLink" 
                                        placeholder="Paste group invite link here"
                                        ref="inviteLinkInput"
                                    />
                                    <button @click="joinGroupFromLink">Join Group</button>
                                </div>
                                <div v-if="joinGroupError" class="error-message">
                                    {{ joinGroupError }}
                            </div>
                        </div>

                        <div class="group-chat-list">
                            <graffiti-discover
                                v-slot="{ objects: groupchatObjects, isInitialPolling }"
                                :channels="['designftw']"
                                :schema="{
                                    properties: {
                                        value: {
                                            required: ['activity','object'],
                                            properties: {
                                                activity: { type: 'string' },
                                                object: {
                                                    type: 'object',
                                                    required: ['type','name','channel'],
                                                    properties: {
                                                        type: { type: 'string' },
                                                        name: { type: 'string' },
                                                        channel: { type: 'string' }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }"
                                @update:objects="updateGroupChats"
                            >
                                <div v-if="isInitialPolling" class="loading">Loading groups...</div>
                                <template v-else>
                                    <div 
                                        v-for="object in groupchatObjects" 
                                        :key="object.url" 
                                        class="group-chat-item"
                                        @click="selectGroupChat(object.value.object.channel, object.value.object.name)"
                                    >
                                        {{ object.value.object.name }}
                                    </div>
                                </template>
                            </graffiti-discover>
                        </div>

                        <div v-if="creatingGroup">
                            <h2>Create Gossip Group</h2>
                            <form @submit.prevent="createGroupChat($graffitiSession.value)">
                                <fieldset :disabled="creating">
                                    <input
                                        type="text"
                                        v-model="groupChatName"
                                        placeholder="My Group Chat"
                                        ref="nameInput"
                                        v-focus
                                    />
                                    <input
                                        type="submit"
                                        :value="creating ? 'Creating...' : 'Create'"
                                    />
                                </fieldset>
                            </form>
                        </div>
                    </div>

                    <div v-else>
                        <div class="header">
                            <div class="clickable" @click="exitGroupChat">
                                <img class="clickable-image" src="img/home.png" style="max-height:80px;"/>
                                <!-- home -->
                            </div>
                            <h2>{{ currentGroupName }}</h2>

                            <div class="clickable" @click="generateGroupInviteLink">
                                <img class="clickable-image" src="img/invite.png" style="max-height:80px;"/>
                                <!-- Invite a Friend -->
                            </div>
                        </div>
                        <div>
                                <div v-if="showInviteLink" class="invite-link-section">
                                    <div class="invite-link-container">
                                        <input 
                                            type="text" 
                                            :value="inviteLink" 
                                            readonly 
                                            ref="inviteLinkInput"
                                        />
                                        <button @click="copyInviteLink">Copy Link</button>
                                    </div>
                                    <div v-if="showCopiedMessage" class="copied-message">
                                        Link copied to clipboard!
                                    </div>
                                </div>
                        </div>
                        <div v-if="showInvitationMessage" class="invitation-message">
                            Invitation sent!
                        </div>
                        

                        <div class="messages-container">
                            <graffiti-discover
                                v-slot="{ objects: messageObjects, isInitialPolling }"
                                :channels="messageChannels"
                                :schema="{
                                    properties: {
                                        value: {
                                            required: ['content', 'published'],
                                            properties: {
                                                content: { type: 'string' },
                                                published: { type: 'number' },
                                                isRumor: { type: 'boolean' }
                                            }
                                        }
                                    }
                                }"
                            >
                                <div v-if="isInitialPolling" class="loading">Loading...</div>
                                <div v-else class="message-list">
                                    <div
                                        v-for="object of messageObjects.sort((a, b) => b.value.published - a.value.published)"
                                        :key="object.url"
                                        class="message"
                                        :class="{ 'rumor-message': object.value.isRumor }"
                                    >
                                        <div class="message-sender clickable" @click="viewUserProfile(object.actor)">
                                            {{ object.actor }}<span v-if="object.actor===$graffitiSession.value.actor">(you)</span>
                                        </div>
                                        <div class="message-content">
                                            {{ object.value.content }}
                                            <span v-if="object.value.isRumor" class="rumor-badge">RUMOR</span>
                                        </div>
                                        <div class="message-time">
                                            {{ new Date(object.value.published).toLocaleTimeString() }}
                                        </div>
                                        <div v-if="object.actor===$graffitiSession.value.actor" class="message-actions">
                                            <button @click="toggleRumor(object, $graffitiSession.value)">
                                                {{ object.value.isRumor ? 'Unmark Rumor' : 'Mark as Rumor' }}
                                            </button>
                                            <button @click="editMessage(object, $graffitiSession.value)">Edit</button>
                                            <button @click="deleteMessage(object, $graffitiSession.value)">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </graffiti-discover>
                        </div>

                        <form @submit.prevent="editingMessage ? saveEdit($graffitiSession.value) : sendMessage($graffitiSession.value)">
                            <fieldset :disabled="sending">
                                <input
                                    type="text"
                                    v-model="myMessage"
                                    :placeholder="editingMessage ? 'Edit message...' : 'Type a message'"
                                    ref="messageInput"
                                    v-focus
                                />
                                <input
                                    type="submit"
                                    :value="sending ? 'Sending...' : (editingMessage ? 'Save Edit' : 'Send')"
                                />
                                <button v-if="editingMessage" @click="editingMessage = null">Cancel</button>
                            </fieldset>
                        </form>
                    </div>
                </template> 
                </div>
            </template>
            </div>
        </div>

        <script src="index.js" type="module"></script>
    </body>
</html>
